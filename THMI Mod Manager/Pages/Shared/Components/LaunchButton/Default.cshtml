@model THMI_Mod_Manager.ViewComponents.LaunchButtonViewModel

<div style="display: block; width: 100%;">
    <button type="button" class="cdx-button cdx-button--primary cdx-launch-button" id="launchButton" onclick="handleLauncherClick()" style="width: 100% !important">
        <i data-icon="@Model.ButtonIcon" class="segoe-icon" style="margin-right: 0.5rem;">@if (Model.ButtonIcon == "icon-stop")
        {<text>&#xE71A;</text>}
        else
        {<text>&#xE768;</text>}</i> 
        <span id="buttonText" class="cdx-launch-button-text">@Model.ButtonText</span>
    </button>
</div>

<style>
.cdx-launch-button {
    width: 100%;
    max-width: 100%;
    min-width: 120px;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0.5rem 1rem !important;
    box-sizing: border-box;
    font-family: var(--font-family-sans, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif);
    min-height: 44px;
    transition: all 0.2s ease-in-out;
    color: #ffffff !important;
    margin: 0 !important;
    white-space: nowrap;
    overflow: visible;
    flex-shrink: 0;
}

.cdx-launch-button-text {
    white-space: nowrap;
    overflow: visible;
    text-overflow: clip;
    display: inline-block;
    max-width: none;
}

.cdx-launch-button {
    background-color: var(--theme-color, #c670ff);
    border-color: var(--theme-color, #c670ff);
}

.cdx-launch-button.cdx-button--safe {
    background-color: var(--color-success, #14866d) !important;
    border-color: var(--color-success, #14866d) !important;
}

.cdx-launch-button.cdx-button--destructive {
    background-color: var(--color-destructive, #d73333) !important;
    border-color: var(--color-destructive, #d73333) !important;
}

.cdx-launch-button:hover,
.cdx-launch-button:focus {
    background-color: var(--theme-color--hover, #d18aff);
    border-color: var(--theme-color--hover, #d18aff);
    color: #ffffff !important;
}

.cdx-launch-button.cdx-button--safe:hover,
.cdx-launch-button.cdx-button--safe:focus {
    background-color: var(--color-success--hover, #179c82) !important;
    border-color: var(--color-success--hover, #179c82) !important;
    color: #ffffff !important;
}

.cdx-launch-button.cdx-button--destructive:hover,
.cdx-launch-button.cdx-button--destructive:focus {
    background-color: var(--color-destructive--hover, #e03535) !important;
    border-color: var(--color-destructive--hover, #e03535) !important;
    color: #ffffff !important;
}

@@media (max-width: 768px) {
    .cdx-launch-button {
        padding: 0.4rem 0.8rem !important;
        font-size: 0.9rem;
        min-height: 40px;
        min-width: 100px;
    }
    
    .cdx-launch-button i {
        margin-right: 0.3rem !important;
    }
}
</style>

<script>
    // 使用函数作用域避免全局变量冲突
    (function() {
        const localizedStrings = {
            launchText: @Html.Raw(Json.Serialize(Model.LaunchText)),
            stopText: @Html.Raw(Json.Serialize(Model.StopText)),
            cancelText: @Html.Raw(Json.Serialize(Model.CancelText)),
            confirmText: @Html.Raw(Json.Serialize(Model.ConfirmText))
        };
        let launchButtonComponentCurrentIsRunning = @(Model.IsProcessRunning.ToString().ToLower());
        
        // 将状态检查函数暴露到全局作用域
        window.checkLaunchButtonStatus = function() {
            checkProcessStatus();
        };
        
        // 将按钮点击处理函数暴露到全局作用域
        window.handleLauncherClick = async function() {
            const action = launchButtonComponentCurrentIsRunning ? 'stop' : 'launch';
            
            if (launchButtonComponentCurrentIsRunning) {
                const shouldStop = await confirmStopGame();
                if (!shouldStop) {
                    return;
                }
            }
            
            // 准备请求数据
            const requestData = {};
            
            fetch(`/api/launcher/${action}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 立即更新按钮状态
                    updateButtonState(!launchButtonComponentCurrentIsRunning);
                    
                    // 延迟后重新检查状态确保准确性
                    if (action === 'launch') {
                        // 启动游戏时，使用更长的延迟和多次检查
                    setTimeout(function() {
                        checkProcessStatusWithRetry(5, 2000);
                    }, 3000);
                } else {
                    // 停止游戏时，正常检查
                    setTimeout(function() {
                        checkProcessStatus();
                    }, 1000);
                    }
                } else {
                    alert('操作失败: ' + (data.message || '未知错误'));
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('操作失败，请重试');
            });
        };
    
    function confirmStopGame() {
        if (typeof ModalUtils !== 'undefined') {
            const confirmMessage = @Html.Raw(Json.Serialize(Model.ConfirmStopMessage));
            return new Promise((resolve) => {
                ModalUtils.confirmStopGame(
                    '',
                    confirmMessage,
                    () => resolve(true),
                    () => resolve(false),
                    {
                        cancelText: localizedStrings.cancelText,
                        confirmText: localizedStrings.confirmText
                    }
                );
            });
        }
        return new Promise((resolve) => {
            const shouldConfirm = confirm(@Html.Raw(Json.Serialize(Model.ConfirmStopMessage)));
            resolve(shouldConfirm);
        });
    }
    
    function updateButtonState(isRunning) {
        launchButtonComponentCurrentIsRunning = isRunning;
        const button = document.querySelector('#launchButton');
        const buttonText = document.getElementById('buttonText');
        const buttonIcon = button.querySelector('i');
        
        if (isRunning) {
            button.className = 'cdx-button cdx-button--destructive cdx-launch-button';
            buttonIcon.setAttribute('data-icon', 'icon-stop');
            buttonIcon.innerHTML = '&#xE71A;';
            buttonText.textContent = localizedStrings.stopText;
        } else {
            button.className = 'cdx-button cdx-button--safe cdx-launch-button';
            buttonIcon.setAttribute('data-icon', 'icon-play');
            buttonIcon.innerHTML = '&#xE768;';
            buttonText.textContent = localizedStrings.launchText;
        }
        
        const event = new CustomEvent('gameStatusChanged', { detail: { isRunning: isRunning } });
        document.dispatchEvent(event);
    }
    
    function checkProcessStatus() {
        fetch('/api/launcher/status')
            .then(response => response.json())
            .then(data => {
                updateButtonState(data.isRunning);
            })
            .catch(error => {
                console.error('检查进程状态时出错:', error);
            });
    }
    
    function checkProcessStatusWithRetry(maxRetries, interval) {
        let retries = 0;
        
        function attemptCheck() {
            fetch('/api/launcher/status')
                .then(response => response.json())
                .then(data => {
                    updateButtonState(data.isRunning);
                    
                    // 如果检测到进程正在运行，或者达到最大重试次数，停止重试
                    if (data.isRunning || retries >= maxRetries) {
                        return;
                    }
                    
                    // 如果进程仍未检测到，继续重试
                    retries++;
                    setTimeout(attemptCheck, interval);
                })
                .catch(error => {
                    console.error('检查进程状态时出错:', error);
                    
                    // 出错时也继续重试，直到达到最大次数
                    if (retries < maxRetries) {
                        retries++;
                        setTimeout(attemptCheck, interval);
                    }
                });
        }
        
        attemptCheck();
    }
    
    // 页面加载完成后立即检查一次状态
    document.addEventListener('DOMContentLoaded', function() {
        checkProcessStatus();
        
        // 定期更新状态（每5秒）
        setInterval(checkProcessStatus, 5000);
    });
    
    })(); // 立即执行函数表达式结束
</script>