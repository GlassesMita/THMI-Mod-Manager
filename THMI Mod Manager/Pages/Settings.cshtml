@page
@model SettingsModel
@inject THMI_Mod_Manager.Services.AppConfigManager AppConfig
@inject THMI_Mod_Manager.Services.LocalizationManager LocalizationManager
@using System.Drawing
@{    
    ViewData["Title"] = AppConfig.GetLocalized("Settings:Title", "Settings");
    var locales = LocalizationManager.GetAvailableLocales();
    var selected = AppConfig.Get("[Localization]Language", "en_US");
    var themeColor = AppConfig.Get("[App]ThemeColor", "#c670ff");
    var launchMode = AppConfig.Get("[Game]LaunchMode", "steam_launch");
    var launcherPath = AppConfig.Get("[Game]LauncherPath", "");
}

<link rel="stylesheet" href="~/css/settings.css" />



<div class="settings-container">
    <h1 class="mods-title" id="settingsTitle" style="cursor: default;">@AppConfig.GetLocalized("Settings:Header", "Settings")</h1>
    <div class="click-counter" id="clickCounter">点击次数: <span id="clickCount">0</span>/10</div>

    <form method="post" asp-page-handler="SaveLanguage" id="settingsForm">
        <div class="mb-3 form-group-animated">
            <label for="languageSelect" class="form-label clickable-label">@AppConfig.GetLocalized("Settings:SelectLanguageLabel", "Language")</label>
            <select id="languageSelect" name="language" class="form-select">
                @foreach (var loc in locales)
                {
                    var fileName = loc.FileName; // original filename e.g. en_US or en-US
                    <option value="@fileName" selected="@(fileName == selected ? "selected" : null)">@loc.FriendlyName</option>
                }
            </select>
        </div>
        <hr class="settings-hr" />
        <!--
        <div class="mb-3 form-group-animated">
            <label for="statusSelect" class="form-label clickable-label">@AppConfig.GetLocalized("Settings:GameStatusLabel", "Game Purchase Status")</label>
            <br />
            <select id="statusSelect" name="status" class="form-select">
                <option value="owned">@AppConfig.GetLocalized("Settings:Owned", "Owned")</option>
                <option value="not_owned">@AppConfig.GetLocalized("Settings:NotOwned", "Not Owned")</option>
            </select>
        </div>
        -->
        <!-- 指针选择器 -->
        <div class="mb-3 form-group-animated">
            <label for="cursorType" class="form-label clickable-label">@AppConfig.GetLocalized("Settings:CursorLabel", "Cursor")</label>
            <select id="cursorType" name="cursorType" class="form-select">
                <option value="default" selected=@(AppConfig.Get("[Cursor]CursorType", "default") == "default")>@AppConfig.GetLocalized("Settings:CursorDefault", "Default Cursor")</option>
                <option value="mystia" selected=@(AppConfig.Get("[Cursor]CursorType", "default") == "mystia")>@AppConfig.GetLocalized("Settings:CursorMystia", "Mystia Cursor (CSS)")</option>
                <option value="osu" selected=@(AppConfig.Get("[Cursor]CursorType", "default") == "osu")>@AppConfig.GetLocalized("Settings:CursorOsu", "osu Cursor (JS)")</option>
            </select>
        </div>

        @*
        <div class="mb-3 form-group-animated">
            <label for="modsPath" class="form-label clickable-label">@AppConfig.GetLocalized("Settings:ModsPathLabel", "Mods Folder")</label>
            <div class="input-group">
                <input type="text" id="modsPath" name="modsPath" class="form-control" value="@AppConfig.Get("[App]ModsPath", AppContext.BaseDirectory)" readonly />
                <button type="button" class="btn btn-primary" id="browseModsPath" data-title="@AppConfig.GetLocalized("FileBrowser:SelectModsFolder", "Select Mods Folder")" disabled>@AppConfig.GetLocalized("Common:Browse", "Browse")</button>
            </div>
        </div>

        <div class="mb-3 form-group-animated">
            <label for="gamePath" class="form-label clickable-label">@AppConfig.GetLocalized("Settings:GamePathLabel", "Game Folder")</label>
            <div class="input-group">
                <input type="text" id="gamePath" name="gamePath" class="form-control" value="@AppConfig.Get("[App]GamePath", "")" readonly />
                <button type="button" class="btn btn-primary" id="browseGamePath" data-title="@AppConfig.GetLocalized("FileBrowser:SelectGameFolder", "Select Game Folder")" disabled>@AppConfig.GetLocalized("Common:Browse", "Browse")</button>
            </div>
        </div>
        *@

        <div class="mb-3 form-group-animated">
            <label for="themeColor" class="form-label clickable-label">@AppConfig.GetLocalized("Settings:ThemeColorLabel", "Theme Color")</label>
            <div class="input-group">
                <input type="color" id="themeColor" name="themeColor" class="form-control form-control-color" value="@themeColor" title="Choose your theme color" />
                <input type="text" id="themeColorText" name="themeColorText" class="form-control" value="@themeColor" />
            </div>
        </div>

        <!--
        <div class="mb-3 form-group-animated">
            <label class="form-label clickable-label">@AppConfig.GetLocalized("Settings:SteamStatusLabel", "Steam Status")</label>
            <div class="checkbox-container">
                <input type="checkbox" id="isSteam" name="isSteam" @(bool.Parse(AppConfig.Get("[App]IsSteam", "true") ?? "true") ? "checked" : "") />
                <label for="isSteam" class="checkbox-label">@AppConfig.GetLocalized("Settings:IsSteam", "Steam Version")</label>
            </div>
        </div>
        -->
        
        <div class="mb-3 form-group-animated">
            <label class="form-label clickable-label">@AppConfig.GetLocalized("Settings:LaunchModeLabel", "Launch Mode")</label>
            <div class="cursor-radio-option">
                <input type="radio" id="launchModeSteam" name="launchMode" value="steam_launch" @(Model.LaunchMode == "steam_launch" ? "checked" : "") onclick="toggleLauncherPath(this)" />
                <label for="launchModeSteam" class="cursor-radio-label">@AppConfig.GetLocalized("Settings:LaunchModeSteam", "Steam Launch")</label>
            </div>
            <div class="cursor-radio-option">
                <input type="radio" id="launchModeExternal" name="launchMode" value="external_program" @(Model.LaunchMode == "external_program" ? "checked" : "") onclick="toggleLauncherPath(this)" />
                <label for="launchModeExternal" class="cursor-radio-label">@AppConfig.GetLocalized("Settings:LaunchModeExternal", "User-Specified External Program")</label>
            </div>
        </div>
        <!-- Hidden fields to pass values to JavaScript -->
        <input type="hidden" id="launchModeHidden" value="@Model.LaunchMode" />
        <input type="hidden" id="localizedProhibitionText" value="@AppConfig.GetLocalized("Settings:ProhibitionText", "Cannot select the Mod Manager's own executable file.")" />
        <!-- Hidden fields for update check localization -->
        <input type="hidden" id="localizedUpdateAvailable" value="@AppConfig.GetLocalized("Updates:UpdateAvailable", "Update available: Version {0}")" />
        <input type="hidden" id="localizedNoReleaseNotes" value="@AppConfig.GetLocalized("Updates:NoReleaseNotes", "No release notes available")" />
        <input type="hidden" id="localizedDownloadUpdate" value="@AppConfig.GetLocalized("Updates:DownloadUpdate", "Download Update")" />
        <input type="hidden" id="localizedNoUpdatesAvailable" value="@AppConfig.GetLocalized("Updates:NoUpdatesAvailable", "No updates available. You are using the latest version.")" />
        <input type="hidden" id="localizedUpdateCheckingDisabled" value="@AppConfig.GetLocalized("Updates:UpdateCheckingDisabled", "Update checking is disabled")" />
        <input type="hidden" id="localizedUpdateCheckFailed" value="@AppConfig.GetLocalized("Updates:UpdateCheckFailed", "Update check failed")" />

        <!-- 修改应用标题开关 -->
        <div class="mb-3 form-group-animated">
            <label class="form-label clickable-label">@AppConfig.GetLocalized("Settings:ModifyTitleLabel", "Modify Application Title")</label>
            <div class="checkbox-container">
                <input type="checkbox" id="modifyTitle" name="modifyTitle" @(Model.ModifyTitle ? "checked" : "") />
                <label for="modifyTitle" class="checkbox-label">@AppConfig.GetLocalized("Settings:ModifyTitleDescription", "Add 'Modded' prefix to game window title")</label>
            </div>
        </div>

        <!-- 更新检查部分 -->
        <div class="mb-3 form-group-animated">
            <label class="form-label clickable-label">@AppConfig.GetLocalized("Updates:Title", "Updates")</label>
            <div class="update-section">
                <div class="checkbox-container">
                    <input type="checkbox" id="autoCheckUpdates" name="autoCheckUpdates" @(Model.AutoCheckUpdates ? "checked" : "") onclick="toggleUpdateFrequency(this)" />
                    <label for="autoCheckUpdates" class="checkbox-label">@AppConfig.GetLocalized("Updates:AutoCheckUpdates", "Automatically check for updates")</label>
                </div>
                <div class="mb-3 mt-3" id="updateFrequencySection">
                    <label for="updateFrequency" class="form-label clickable-label">@AppConfig.GetLocalized("Updates:UpdateFrequencyLabel", "Update Frequency")</label>
                    <select id="updateFrequency" name="updateFrequency" class="form-select">
                        <option value="startup" selected="@(Model.UpdateFrequency == "startup")">@AppConfig.GetLocalized("Updates:FrequencyStartup", "On Startup")</option>
                        <option value="weekly" selected="@(Model.UpdateFrequency == "weekly")">@AppConfig.GetLocalized("Updates:FrequencyWeekly", "Every Monday")</option>
                        <option value="monthly" selected="@(Model.UpdateFrequency == "monthly")">@AppConfig.GetLocalized("Updates:FrequencyMonthly", "First Day of Month")</option>
                    </select>
                </div>
                <div class="update-info mt-2">
                    <div class="current-version">
                        <small class="text-muted">
                            @string.Format(AppConfig.GetLocalized("Updates:CurrentVersionInfo", "Current version: {0} {1}"), Model.ModName, Model.ModVersion)
                        </small>
                    </div>
                    <div class="update-status mt-2" id="updateStatus" style="display: none;">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">@AppConfig.GetLocalized("Common:Loading", "Loading...")</span>
                        </div>
                        <span class="ms-2">@AppConfig.GetLocalized("Updates:CheckForUpdates", "Checking for updates...")</span>
                    </div>
                    <div class="update-result mt-2" id="updateResult" style="display: none;">
                    </div>
                    <div class="update-progress mt-2" id="updateProgress" style="display: none;">
                        <div class="progress">
                            <div class="progress-bar" id="updateProgressBar" role="progressbar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted" id="updateProgressText">0%</small>
                    </div>
                </div>
                <div class="update-actions mt-2">
                    <button type="button" class="btn btn-primary btn-sm" id="checkNowButton">
                        @AppConfig.GetLocalized("Updates:CheckNowButton", "Check Now")
                    </button>
                    <button type="button" class="btn btn-success btn-sm" id="downloadUpdateButton" style="display: none;">
                        @AppConfig.GetLocalized("Updates:DownloadButton", "Download Update")
                    </button>
                    <button type="button" class="btn btn-info btn-sm" id="applyUpdateButton" style="display: none;">
                        @AppConfig.GetLocalized("Updates:ApplyUpdateButton", "Apply Update & Restart")
                    </button>
                </div>
            </div>
        </div>

        <div class="launcher-path-section" id="launcherPathSection">
            <div class="mb-3 form-group-animated">
                <label for="launcherPath" class="form-label clickable-label">@AppConfig.GetLocalized("Settings:LauncherPathLabel", "External Program Path")</label>
                <div class="input-group">
                    <input type="text" id="launcherPath" name="launcherPath" class="form-control" value="@Model.LauncherPath" />
                    <button type="button" class="btn btn-primary" id="browseLauncherPath" data-title="@AppConfig.GetLocalized("FileBrowser:SelectExecutable", "Select Executable File")">@AppConfig.GetLocalized("Common:Browse", "Browse")</button>
                </div>
                <div id="launcherPathError" class="text-danger mt-1"></div>
                <small id="launcherPathNote" class="form-text text-muted">@AppConfig.GetLocalized("Settings:LauncherPathNote", "Select the executable file to launch the game. The Mod Manager's own executable is not allowed.")</small>
                <div class="mt-2">
                    <a href="https://store.steampowered.com/app/1584090/" target="_blank" rel="noopener noreferrer" class="text-info">
                        @AppConfig.GetLocalized("Settings:PurchaseLegitimateGame", "Purchase the authorized game for a better experience.")
                    </a>
                </div>
            </div>
        </div>

        <button type="submit" class="btn btn-primary save-button" id="saveButton">
            <span id="saveText">@AppConfig.GetLocalized("Common:Save", "Save")</span>
            <div id="loadingSpinner" class="spinner-border spinner-border-sm" style="display: none;" role="status">
                <span class="visually-hidden">@AppConfig.GetLocalized("Common:Saving", "Saving...")</span>
            </div>
        </button>
    </form>

    <div class="success-toast" id="successToast">
        @AppConfig.GetLocalized("Settings:ChangesSaved", "Changes saved successfully!")
    </div>
</div>

<script src="~/js/settings.js"></script>

