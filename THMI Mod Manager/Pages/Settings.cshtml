@page
@model SettingsModel
@inject THMI_Mod_Manager.Services.AppConfigManager AppConfig
@inject THMI_Mod_Manager.Services.LocalizationManager LocalizationManager
@{
    ViewData["Title"] = AppConfig.GetLocalized("Settings:Title", "Settings");
    var locales = LocalizationManager.GetAvailableLocales();
    var selected = AppConfig.Get("[Localization]Language", "en_US");
}

<style>
    /* Settings页面动画样式 */
    .settings-container {
        animation: fadeIn 0.5s ease-in-out;
    }

    .settings-title {
        animation: slideDown 0.6s ease-out;
        transform-origin: top left;
    }

    .form-group-animated {
        opacity: 0;
        animation: fadeInUp 0.5s ease-out forwards;
        transform: translateY(20px);
    }

    .form-group-animated:nth-child(1) { animation-delay: 0.1s; }
    .form-group-animated:nth-child(2) { animation-delay: 0.2s; }
    .form-group-animated:nth-child(3) { animation-delay: 0.3s; }
    .form-group-animated:nth-child(4) { animation-delay: 0.4s; }

    .form-label {
        transition: all 0.3s ease;
        display: inline-block;
        position: relative;
    }

    .form-label:hover {
        color: #0d6efd;
        transform: translateX(5px);
    }

    .btn-primary {
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 0.375rem;
        position: relative;
        overflow: hidden;
    }

    .btn-primary:hover {
        transform: translateY(-2px) scale(1.02);
        box-shadow: 0 8px 25px rgba(13, 110, 253, 0.15);
    }

    .btn-primary:focus {
        transform: translateY(-1px) scale(1.01);
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    .btn-primary {
        position: relative;
        overflow: hidden;
    }

    .btn-primary::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }

    .btn-primary:hover::before {
        left: 100%;
    }

    .checkbox-container {
        display: inline-flex;
        align-items: center;
        cursor: pointer;
        position: relative;
        padding: 8px 12px;
        border-radius: 0.375rem;
        transition: all 0.3s ease;
    }

    .checkbox-container:hover {
        background-color: rgba(13, 110, 253, 0.1);
        transform: translateX(5px);
    }

    .checkbox-container input[type="checkbox"] {
        margin-right: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
    }

    .checkbox-container input[type="checkbox"]:checked {
        transform: scale(1.1);
    }

    .checkbox-label {
        transition: all 0.3s ease;
    }

    .checkbox-container:hover .checkbox-label {
        color: #0d6efd;
    }

    .settings-hr {
        height: 2px;
        background-image: linear-gradient(to right, rgba(13, 110, 253, 0), rgba(13, 110, 253, 0.75), rgba(13, 110, 253, 0));
        border: 0;
        margin: 1.5rem 0;
        animation: expandWidth 1s ease-out;
    }

    /* 动画关键帧 */
    @@keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    @@keyframes slideDown {
        from { 
            opacity: 0;
            transform: translateY(-20px);
        }
        to { 
            opacity: 1;
            transform: translateY(0);
        }
    }

    @@keyframes fadeInUp {
        from { 
            opacity: 0;
            transform: translateY(20px);
        }
        to { 
            opacity: 1;
            transform: translateY(0);
        }
    }

    @@keyframes expandWidth {
        from { width: 0; }
        to { width: 100%; }
    }

    /* 表单提交动画 - 已更新为按钮加载样式 */

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    /* 成功提示动画 */
    .success-toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #198754;
        color: white;
        padding: 15px 20px;
        border-radius: 0.375rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        transform: translateX(120%);
        transition: transform 0.3s ease-out;
        z-index: 1000;
    }

    .success-toast.show {
        transform: translateX(0);
    }

    /* 可点击标签样式 */
    .clickable-label {
        cursor: pointer;
        user-select: none;
        transition: all 0.2s ease;
    }

    .clickable-label:hover {
        color: #0d6efd;
        transform: translateX(2px);
    }

    .clickable-label:active {
        transform: translateX(1px);
    }

    /* Bootstrap 自定义选择框样式 */
    .form-select {
        background-color: #fff;
        border: 1px solid #ced4da;
        border-radius: 0.375rem;
        padding: 0.375rem 2.25rem 0.375rem 0.75rem;
        font-size: 1rem;
        font-weight: 400;
        line-height: 1.5;
        color: #212529;
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
        background-position: right 0.5rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
        transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
        appearance: none;
    }

    .form-select:focus {
        border-color: #86b7fe;
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    .form-select:hover {
        border-color: #86b7fe;
    }

    .form-select:disabled {
        background-color: #e9ecef;
        opacity: 1;
    }

    .form-select:focus {
        border-color: #86b7fe;
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    /* 自定义复选框样式 */
    .checkbox-container {
        display: flex;
        align-items: center;
        padding: 0.5rem;
        border-radius: 0.375rem;
        transition: background-color 0.15s ease-in-out;
    }

    .checkbox-container input[type="checkbox"] {
        width: 1.25rem;
        height: 1.25rem;
        margin-right: 0.5rem;
        cursor: pointer;
        accent-color: #0d6efd;
    }

    .checkbox-label {
        margin-bottom: 0;
        cursor: pointer;
        font-weight: 400;
        color: #212529;
    }

    /* 表单组间距优化 */
    .form-group-animated {
        margin-bottom: 1.5rem;
    }

    .form-label {
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: #495057;
    }

    /* Bootstrap 按钮样式增强 */
    .btn {
        display: inline-block;
        font-weight: 400;
        line-height: 1.5;
        color: #212529;
        text-align: center;
        text-decoration: none;
        vertical-align: middle;
        cursor: pointer;
        user-select: none;
        background-color: transparent;
        border: 1px solid transparent;
        padding: 0.375rem 0.75rem;
        font-size: 1rem;
        border-radius: 0.375rem;
        transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
    }

    .btn-primary {
        color: #fff;
        background-color: #0d6efd;
        border-color: #0d6efd;
    }

    .btn-primary:hover {
        color: #fff;
        background-color: #0b5ed7;
        border-color: #0a58ca;
    }

    .btn-primary:focus {
        color: #fff;
        background-color: #0b5ed7;
        border-color: #0a58ca;
        box-shadow: 0 0 0 0.25rem rgba(49, 132, 253, 0.5);
    }

    .btn-primary:active {
        color: #fff;
        background-color: #0a58ca;
        border-color: #0a53be;
    }

    /* 设置容器样式 */
    .settings-container {
        max-width: 600px;
        margin: 2rem auto;
        padding: 2rem;
        background-color: #fff;
        border-radius: 0.5rem;
        box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    }

    .settings-title {
        margin-bottom: 2rem;
        color: #212529;
        font-weight: 500;
        font-size: 1.75rem;
        text-align: center;
    }

    /* 响应式设计 */
    @@media (max-width: 768px) {
        .settings-container {
            margin: 1rem;
            padding: 1.5rem;
        }
        
        .settings-title {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
        }
    }

    /* 自定义分隔线样式 */
    .settings-hr {
        margin: 1.5rem 0;
        color: inherit;
        background-color: currentColor;
        border: 0;
        opacity: 0.25;
        height: 1px;
    }

    /* 表单控件焦点状态增强 */
    .form-control:focus,
    .form-select:focus {
        border-color: #86b7fe;
        outline: 0;
        box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
    }

    /* 按钮加载状态 */
    .btn.loading {
        position: relative;
        color: transparent;
    }

    .btn.loading::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 1rem;
        height: 1rem;
        margin: -0.5rem 0 0 -0.5rem;
        border: 0.125rem solid currentColor;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 0.75s linear infinite;
        color: #fff;
    }

    /* 开发者设置样式 */
    .developer-section {
        display: none;
        margin-top: 2rem;
        padding: 1.5rem;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        animation: fadeInUp 0.5s ease-out;
    }

    .developer-section.show {
        display: block;
    }

    .developer-title {
        color: #dc3545;
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1rem;
        text-align: center;
    }

    .click-counter {
        position: fixed;
        top: 10px;
        right: 10px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 12px;
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 1000;
        display: none; /* 完全隐藏点击计数器 */
    }

    .click-counter.show {
        opacity: 1;
    }

    .settings-title {
        cursor: default; /* 改为默认指针 */
        user-select: none;
        transition: opacity 0.2s ease;
    }

    .settings-title:hover {
        opacity: 0.8;
    }


</style>

<div class="settings-container">
    <h2 class="settings-title" id="settingsTitle" style="cursor: default;">@AppConfig.GetLocalized("Settings:Header", "Settings")</h2>
    <div class="click-counter" id="clickCounter">点击次数: <span id="clickCount">0</span>/10</div>

    <form method="post" asp-page-handler="SaveLanguage" id="settingsForm">
        <div class="mb-3 form-group-animated">
            <label for="languageSelect" class="form-label clickable-label">@AppConfig.GetLocalized("Settings:SelectLanguageLabel", "Language")</label>
            <select id="languageSelect" name="language" class="form-select">
                @foreach (var loc in locales)
                {
                    var fileName = loc.FileName; // original filename e.g. en_US or en-US
                    <option value="@fileName" selected="@(fileName == selected ? "selected" : null)">@loc.FriendlyName</option>
                }
            </select>
        </div>
        <hr class="settings-hr" />
        <div class="mb-3 form-group-animated">
            <label for="statusSelect" class="form-label clickable-label">@AppConfig.GetLocalized("Settings:GameStatusLabel", "Game Purchase Status")</label>
            <br />
            <select id="statusSelect" name="status" class="form-select">
                <option value="owned">@AppConfig.GetLocalized("Settings:Owned", "Owned")</option>
                <option value="not_owned">@AppConfig.GetLocalized("Settings:NotOwned", "Not Owned")</option>
            </select>
        </div>
        <div class="mb-3 form-group-animated">
            <label class="form-label clickable-label">@AppConfig.GetLocalized("Settings:CursorLabel", "Cursor")</label>
            <br />
            <div class="checkbox-container">
                <input type="checkbox" id="useMystiaCursor" name="useMystiaCursor" value="true" />
                <label for="useMystiaCursor" class="checkbox-label clickable-label">@AppConfig.GetLocalized("Settings:UseMystiaCursorLabel", "Use Mystia Cursor")</label>
            </div>
        </div>
        <div class="mb-3 form-group-animated">
            <button type="submit" class="btn btn-primary">@AppConfig.GetLocalized("Settings:SaveButton", "Save")</button>
        </div>
    </form>

    <!-- 开发者设置部分 -->
    <div class="developer-section" id="developerSection">
        <h3 class="developer-title">⚠️ @AppConfig.GetLocalized("Settings:DeveloperSettings", "Developer Settings")</h3>
        <hr class="settings-hr" />
        
        <div class="mb-3 form-group-animated">
            <label class="form-label clickable-label">@AppConfig.GetLocalized("Settings:DevModeLabel", "Development Mode")</label>
            <br />
            <div class="checkbox-container">
                <input type="checkbox" id="devMode" name="devMode" value="true" />
                <label for="devMode" class="checkbox-label clickable-label">@AppConfig.GetLocalized("Settings:EnableDevMode", "Enable Development Mode")</label>
            </div>
        </div>
        
        <div class="mb-3 form-group-animated">
            <label class="form-label clickable-label">@AppConfig.GetLocalized("Settings:CVEWarningLabel", "CVE Vulnerability Detection")</label>
            <br />
            <div class="checkbox-container">
                <input type="checkbox" id="showCVEWarning" name="showCVEWarning" value="true" checked />
                <label for="showCVEWarning" class="checkbox-label clickable-label">@AppConfig.GetLocalized("Settings:ShowCVEWarning", "Show CVE-2025-59489 Security Warning")</label>
            </div>
        </div>
        
        <div class="mb-3 form-group-animated">
            <button type="button" class="btn btn-primary" onclick="saveDeveloperSettings()">@AppConfig.GetLocalized("Settings:SaveDeveloperSettings", "Save Developer Settings")</button>
        </div>
    </div>
</div>

<div id="successToast" class="success-toast">
    @AppConfig.GetLocalized("Settings:SaveSuccessMessage", "Settings saved successfully!")
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('settingsForm');
        const successToast = document.getElementById('successToast');
        const selects = document.querySelectorAll('.form-select');
        
        // 为所有下拉框添加动画效果
        selects.forEach((select, index) => {
            // 改变值时的动画
            select.addEventListener('change', function() {
                // 添加成功反馈
                this.style.borderColor = '#198754';
                setTimeout(() => {
                    this.style.borderColor = '';
                }, 1500);
            });
        });
        
        form.addEventListener('submit', function(e) {
            // 添加保存动画
            const submitButton = form.querySelector('.btn-primary');
            submitButton.classList.add('loading');
            submitButton.disabled = true;
            
            // 模拟表单提交过程
            setTimeout(function() {
                submitButton.classList.remove('loading');
                submitButton.disabled = false;
                
                // 显示成功提示
                successToast.classList.add('show');
                
                // 3秒后隐藏成功提示
                setTimeout(function() {
                    successToast.classList.remove('show');
                }, 3000);
            }, 1000);
        });
        
        // 为复选框添加交互效果
        const checkbox = document.getElementById('useMystiaCursor');
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                this.parentElement.style.backgroundColor = 'rgba(13, 110, 253, 0.1)';
            } else {
                this.parentElement.style.backgroundColor = 'transparent';
            }
        });
        

        

        

    // 开发者设置相关功能
        let clickCount = 0;
        const settingsTitle = document.getElementById('settingsTitle');
        const clickCounter = document.getElementById('clickCounter');
        const clickCountSpan = document.getElementById('clickCount');
        const developerSection = document.getElementById('developerSection');
        
        // 从配置加载开发者设置
        function loadDeveloperSettings() {
            // 从AppConfig加载实际的设置值
            const isDevMode = '@(Model.IsDevMode ? "true" : "false")' === 'true';
            const showCVE = '@(Model.ShowCVEWarning ? "true" : "false")' === 'true';
            
            document.getElementById('devMode').checked = isDevMode;
            document.getElementById('showCVEWarning').checked = showCVE;
        }
        
        // 保存开发者设置
        window.saveDeveloperSettings = function() {
            const devMode = document.getElementById('devMode').checked;
            const showCVEWarning = document.getElementById('showCVEWarning').checked;
            
            // 创建表单数据
            const formData = new FormData();
            formData.append('devMode', devMode);
            formData.append('showCVEWarning', showCVEWarning);
            
            // 发送到后端保存
            fetch('/settings?handler=SaveDeveloperSettings', {
                method: 'POST',
                body: formData,
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 保存到本地存储
                    localStorage.setItem('developerMode', devMode);
                    localStorage.setItem('showCVEWarning', showCVEWarning);
                    
                    // 如果开发模式开启，立即显示开发者设置
                    if (devMode) {
                        developerSection.classList.add('show');
                    }
                    
                    // 显示成功提示
                    const successToast = document.getElementById('successToast');
                    successToast.textContent = data.message || '开发者设置已保存！';
                    successToast.classList.add('show');
                    
                    setTimeout(function() {
                        successToast.classList.remove('show');
                        successToast.textContent = '@AppConfig.GetLocalized("Settings:SaveSuccessMessage", "Settings saved successfully!")';
                    }, 3000);
                }
            })
            .catch(error => {
                console.error('保存开发者设置失败:', error);
                alert('保存失败，请重试');
            });
        };
        
        // 标题点击事件
        settingsTitle.addEventListener('click', function() {
            clickCount++;
            clickCountSpan.textContent = clickCount;
            clickCounter.classList.add('show');
            
            if (clickCount >= 10) {
                developerSection.classList.add('show');
                clickCounter.style.display = 'none';
                loadDeveloperSettings();
                
                // 显示解锁提示
                const successToast = document.getElementById('successToast');
                successToast.textContent = '@AppConfig.GetLocalized("Settings:DeveloperUnlocked", "🔓 Developer options unlocked!")';
                successToast.classList.add('show');
                
                setTimeout(function() {
                    successToast.classList.remove('show');
                    successToast.textContent = '@AppConfig.GetLocalized("Settings:SaveSuccessMessage", "Settings saved successfully!")';
                }, 3000);
            }
            
            // 3秒后隐藏计数器
            setTimeout(function() {
                if (clickCount < 10) {
                    clickCounter.classList.remove('show');
                }
            }, 3000);
        });
        
        // 初始化开发者设置（如果已解锁）
        if (localStorage.getItem('developerMode') === 'true') {
            developerSection.classList.add('show');
            loadDeveloperSettings();
        }

    });
</script>