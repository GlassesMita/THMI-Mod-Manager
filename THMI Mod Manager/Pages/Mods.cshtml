@page
@model ModsModel
@inject THMI_Mod_Manager.Services.AppConfigManager AppConfig
@{
    ViewData["Title"] = AppConfig.GetLocalized("Mods:Title", "Mod 管理");
    var themeColor = AppConfig.Get("[App]ThemeColor", "#c670ff");
}

<input type="hidden" id="themeColorHidden" value="@themeColor" />

<div class="mods-container">
    <div class="mods-header">
        <h1 class="mods-title">@AppConfig.GetLocalized("Mods:Header", "Mod 管理")</h1>
        <div class="mods-actions">
            <button id="installModsButton" class="btn btn-outline-success me-2">
                <i class="bi bi-plus-circle"></i>
                <span>@AppConfig.GetLocalized("Mods:InstallButton", "安装")</span>
            </button>
            <button id="refreshModsButton" class="btn btn-outline-primary">
                <i class="bi bi-arrow-clockwise"></i>
                <span>@AppConfig.GetLocalized("Mods:RefreshButton", "刷新")</span>
            </button>
            <select id="sortOrder" class="form-select" onchange="modsManager.changeSortOrder(this.value)">
                <option value="name">@AppConfig.GetLocalized("Mods:SortByName", "名称")</option>
                <option value="date">@AppConfig.GetLocalized("Mods:SortByDate", "安装时间")</option>
            </select>
        </div>
    </div>
    
    <div class="mods-content">
        <div id="modsList" class="mods-list">
            <div class="text-center py-5">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">@AppConfig.GetLocalized("Mods:Loading", "加载中...")</span>
                </div>
            </div>
        </div>
        
        <div id="modsEmpty" class="mods-empty" style="display: none;">
            <div class="empty-icon">
                <i class="bi bi-box-seam"></i>
            </div>
            <h2>@AppConfig.GetLocalized("Mods:NoMods", "暂无 Mod")</h2>
            <p>@AppConfig.GetLocalized("Mods:NoModsDesc", "BepInEx/plugins 目录中没有找到任何 Mod 文件。")</p>
        </div>
        
        <div id="modsError" class="mods-error" style="display: none;">
            <div class="alert alert-danger" role="alert">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <span id="modsErrorMessage">@AppConfig.GetLocalized("Mods:LoadError", "加载 Mod 时发生错误")</span>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/mods.css" />
}

@section Scripts {
    <script src="~/js/mods.js"></script>
    <script>
        // 初始化文件浏览器按钮事件
        document.addEventListener('DOMContentLoaded', function() {
            const installModsButton = document.getElementById('installModsButton');
            if (installModsButton) {
                installModsButton.addEventListener('click', function() {
                    // 使用全局文件浏览器打开
                    if (window.fileBrowser) {
                        window.fileBrowser.open('file', {
                            title: '@Html.Raw(AppConfig.GetLocalized("Mods:FileBrowserTitle", "选择 Zip 文件"))',
                            extensions: ['.zip'],
                            onFileSelected: function(filePath) {
                                // 文件选择后执行安装
                                installMod(filePath);
                            },
                            hideFileFilter: true
                        });
                    }
                });
            }
        });
        
        // 安装Mod的函数
        async function installMod(filePath) {
            const fileName = filePath.split(/[\\/]/).pop();
            
            if (confirm(`确定要安装 Mod: ${fileName} 吗？`)) {
                try {
                    const response = await fetch('/api/mods/install', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ filePath: filePath })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        alert('Mod 安装成功！');
                        modsManager.loadMods();
                    } else {
                        alert('Mod 安装失败: ' + (data.message || '未知错误'));
                    }
                } catch (error) {
                    alert('安装 Mod 时出错: ' + error.message);
                }
            }
        }
    </script>
    <script>
        // 添加折叠功能的JavaScript代码
        function toggleModDetails(modId) {
            const details = document.getElementById('mod-details-' + modId);
            const toggleIcon = document.getElementById('toggle-icon-' + modId);
            
            if (details.style.display === 'none' || details.style.display === '') {
                details.style.display = 'block';
                toggleIcon.classList.remove('bi-chevron-down');
                toggleIcon.classList.add('bi-chevron-up');
            } else {
                details.style.display = 'none';
                toggleIcon.classList.remove('bi-chevron-up');
                toggleIcon.classList.add('bi-chevron-down');
            }
        }
        
        // 删除确认函数
        function confirmDeleteMod(fileName) {
            const confirmMessage = '@Html.Raw(AppConfig.GetLocalized("Mods:DeleteConfirm", "Are you sure you want to delete the mod"))'.replace("{0}", fileName);
            if (confirm(confirmMessage)) {
                deleteMod(fileName);
            }
        }
        
        // 删除mod的函数
        async function deleteMod(fileName) {
            try {
                const response = await fetch(`${window.location.origin}/api/mods/${encodeURIComponent(fileName)}`, {
                    method: 'DELETE'
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    // 重新加载mod列表
                    modsManager.loadMods();
                } else {
                    const errorMessage = '@Html.Raw(AppConfig.GetLocalized("Mods:DeleteFailed", "Failed to delete Mod"))' + ': ' + data.message;
                    alert(errorMessage);
                }
            } catch (error) {
                console.error('删除Mod时出错:', error);
                const errorMessage = '@Html.Raw(AppConfig.GetLocalized("Mods:DeleteError", "Error deleting Mod"))'.replace("{0}", error.message);
                alert(errorMessage);
            }
        }
    </script>
}
