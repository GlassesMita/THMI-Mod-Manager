@page
@model ModsModel
@inject THMI_Mod_Manager.Services.AppConfigManager AppConfig
@{
    ViewData["Title"] = AppConfig.GetLocalized("Mods:Title", "Mod 管理");
    var themeColor = AppConfig.Get("[App]ThemeColor", "#c670ff");
}

<input type="hidden" id="themeColorHidden" value="@themeColor" />

<div class="mods-container">
    <div class="mods-header">
        <h1 class="mods-title">@AppConfig.GetLocalized("Mods:Header", "Mod 管理")</h1>
        <div class="mods-actions">
            <button id="installModsButton" class="btn btn-outline-success me-2">
                <i class="bi bi-plus-circle"></i>
                <span>@AppConfig.GetLocalized("Mods:InstallButton", "安装")</span>
            </button>
            <button id="refreshModsButton" class="btn btn-outline-primary">
                <i class="bi bi-arrow-clockwise"></i>
                <span>@AppConfig.GetLocalized("Mods:RefreshButton", "刷新")</span>
            </button>
            <select id="sortOrder" class="form-select" onchange="modsManager.changeSortOrder(this.value)">
                <option value="name">@AppConfig.GetLocalized("Mods:SortByName", "名称")</option>
                <option value="date">@AppConfig.GetLocalized("Mods:SortByDate", "安装时间")</option>
            </select>
        </div>
    </div>
    
    <div class="mods-content">
        <div id="modsList" class="mods-list">
            <div class="text-center py-5">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">@AppConfig.GetLocalized("Mods:Loading", "加载中...")</span>
                </div>
            </div>
        </div>
        
        <div id="modsEmpty" class="mods-empty" style="display: none;">
            <div class="empty-icon">
                <i class="bi bi-box-seam"></i>
            </div>
            <h2>@AppConfig.GetLocalized("Mods:NoMods", "暂无 Mod")</h2>
            <p>@AppConfig.GetLocalized("Mods:NoModsDesc", "BepInEx/plugins 目录中没有找到任何 Mod 文件。")</p>
        </div>
        
        <div id="modsError" class="mods-error" style="display: none;">
            <div class="alert alert-danger" role="alert">
                <i class="bi bi-exclamation-triangle-fill"></i>
                <span id="modsErrorMessage">@AppConfig.GetLocalized("Mods:LoadError", "加载 Mod 时发生错误")</span>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/mods.css" />
}

@section Scripts {
    <script src="~/js/mods-renderer.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const refreshButton = document.getElementById('refreshModsButton');
            if (refreshButton) {
                refreshButton.addEventListener('click', function() {
                    if (window.ModRenderer) {
                        window.ModRenderer.refresh();
                    }
                });
            }
            
            const installModsButton = document.getElementById('installModsButton');
            if (installModsButton) {
                installModsButton.addEventListener('click', function() {
                    if (window.fileBrowser) {
                        window.fileBrowser.open('file', {
                            title: '@Html.Raw(AppConfig.GetLocalized("Mods:FileBrowserTitle", "选择 Zip 文件"))',
                            extensions: ['.zip'],
                            onFileSelected: function(filePath) {
                                installMod(filePath);
                            },
                            hideFileFilter: true
                        });
                    }
                });
            }
        });
        
        async function installMod(filePath) {
            const fileName = filePath.split(/[\\/]/).pop();
            if (confirm('确定要安装 Mod: ' + fileName + ' 吗？')) {
                try {
                    const response = await fetch('/api/mods/install', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filePath: filePath })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        alert('Mod 安装成功！');
                        if (window.ModRenderer) {
                            window.ModRenderer.refresh();
                        }
                    } else {
                        alert('Mod 安装失败: ' + (data.message || '未知错误'));
                    }
                } catch (error) {
                    alert('安装 Mod 时出错: ' + error.message);
                }
            }
        }
    </script>
}
