@page
@model ModsModel
@inject THMI_Mod_Manager.Services.AppConfigManager AppConfig
@{
    ViewData["Title"] = AppConfig.GetLocalized("Mods:Title", "Mod 管理");
    var themeColor = AppConfig.Get("[App]ThemeColor", "#c670ff");
}

<input type="hidden" id="themeColorHidden" value="@themeColor" />
<input type="hidden" id="localizedEnable" value="@AppConfig.GetLocalized("Mods:EnableButton", "启用")" />
<input type="hidden" id="localizedDisable" value="@AppConfig.GetLocalized("Mods:DisableButton", "禁用")" />
<input type="hidden" id="localizedUpdate" value="@AppConfig.GetLocalized("Mods:UpdateButton", "更新")" />
<input type="hidden" id="localizedDelete" value="@AppConfig.GetLocalized("Mods:DeleteButton", "删除")" />
<input type="hidden" id="localizedConfig" value="@AppConfig.GetLocalized("Mods:ConfigButton", "设置")" />
<input type="hidden" id="localizedNewVersion" value="@AppConfig.GetLocalized("Mods:NewVersion", "新版本:")" />
<input type="hidden" id="localizedCurrent" value="@AppConfig.GetLocalized("Mods:Current", "当前:")" />
<input type="hidden" id="localizedChangelog" value="@AppConfig.GetLocalized("Mods:Changelog", "更新日志")" />
<input type="hidden" id="localizedViewOnGithub" value="@AppConfig.GetLocalized("Mods:ViewOnGithub", "在 Github 上查看")" />
<input type="hidden" id="localizedLink" value="@AppConfig.GetLocalized("Mods:Link", "Link:")" />
<input type="hidden" id="localizedAuthor" value="@AppConfig.GetLocalized("Mods:Author", "作者:")" />
<input type="hidden" id="localizedId" value="@AppConfig.GetLocalized("Mods:Id", "ID:")" />
<input type="hidden" id="localizedModDesc" value="@AppConfig.GetLocalized("Mods:Description", "Mod Desc:")" />
<input type="hidden" id="localizedUpdateAvailable" value="@AppConfig.GetLocalized("Mods:UpdateAvailable", "有新版本可用")" />
<input type="hidden" id="localizedModConfigTitle" value="@AppConfig.GetLocalized("ModConfig:Title", "Mod Config")" />
<input type="hidden" id="localizedModConfigSave" value="@AppConfig.GetLocalized("ModConfig:Save", "Save")" />
<input type="hidden" id="localizedModConfigSaving" value="@AppConfig.GetLocalized("ModConfig:Saving", "Saving...")" />
<input type="hidden" id="localizedModConfigSaveSuccess" value="@AppConfig.GetLocalized("ModConfig:SaveSuccess", "Configuration saved successfully")" />
<input type="hidden" id="localizedModConfigSaveError" value="@AppConfig.GetLocalized("ModConfig:SaveError", "Failed to save configuration")" />
<input type="hidden" id="localizedModConfigLoading" value="@AppConfig.GetLocalized("ModConfig:Loading", "Loading...")" />
<input type="hidden" id="localizedModConfigLoadError" value="@AppConfig.GetLocalized("ModConfig:LoadError", "Failed to load")" />
<input type="hidden" id="localizedModConfigConfigHint" value="@AppConfig.GetLocalized("ModConfig:ConfigHint", "Edit configuration file directly. Click Save to apply changes.")" />
<input type="hidden" id="localizedModConfigCancel" value="@AppConfig.GetLocalized("ModConfig:Cancel", "Cancel")" />

<div class="mods-container">
    <div class="mods-header">
        <h1 class="mods-title">@AppConfig.GetLocalized("Mods:Header", "Mod 管理")</h1>
        <div class="mods-actions">
            <button id="checkUpdatesButton" class="btn btn-outline-info me-2">
                                <i data-icon="icon-refresh"></i>
                <span>@AppConfig.GetLocalized("Mods:CheckUpdatesButton", "检查更新")</span>
            </button>
            <button id="installModsButton" class="btn btn-outline-success me-2">
                                <i data-icon="icon-add"></i>
                <span>@AppConfig.GetLocalized("Mods:InstallButton", "安装")</span>
            </button>
            <button id="refreshModsButton" class="btn btn-outline-primary">
                                <i data-icon="icon-refresh"></i>
                <span>@AppConfig.GetLocalized("Mods:RefreshButton", "刷新")</span>
            </button>
            <select id="sortOrder" class="form-select" onchange="modsManager.changeSortOrder(this.value)">
                <option value="name">@AppConfig.GetLocalized("Mods:SortByName", "名称")</option>
                <option value="date">@AppConfig.GetLocalized("Mods:SortByDate", "安装时间")</option>
            </select>
        </div>
    </div>
    
    <div class="mods-content">
        <div id="modsList" class="mods-list">
            <div class="text-center py-5">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">@AppConfig.GetLocalized("Mods:Loading", "加载中...")</span>
                </div>
            </div>
        </div>
        
        <div id="modsEmpty" class="mods-empty" style="display: none;">
            <div class="empty-icon">
                                <i data-icon="icon-mods"></i>
            </div>
            <h2>@AppConfig.GetLocalized("Mods:NoMods", "暂无 Mod")</h2>
            <p>@AppConfig.GetLocalized("Mods:NoModsDesc", "BepInEx/plugins 目录中没有找到任何 Mod 文件。")</p>
        </div>
        
        <div id="modsError" class="mods-error" style="display: none;">
            <div class="alert alert-danger" role="alert">
                                <i data-icon="icon-warning"></i>
                <span id="modsErrorMessage">@AppConfig.GetLocalized("Mods:LoadError", "加载 Mod 时发生错误")</span>
            </div>
        </div>
    </div>
</div>

@section Styles {
    <link rel="stylesheet" href="~/css/mods.css" />
}

@section Scripts {
    <script src="~/js/mods-renderer.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const refreshButton = document.getElementById('refreshModsButton');
            if (refreshButton) {
                refreshButton.addEventListener('click', function() {
                    if (window.ModRenderer) {
                        window.ModRenderer.refresh();
                    }
                });
            }
            
            const checkUpdatesButton = document.getElementById('checkUpdatesButton');
            if (checkUpdatesButton) {
                checkUpdatesButton.addEventListener('click', function() {
                    if (window.ModRenderer) {
                        window.ModRenderer.checkForUpdates();
                    }
                });
            }
            
            const installModsButton = document.getElementById('installModsButton');
            if (installModsButton) {
                installModsButton.addEventListener('click', function() {
                    if (window.fileBrowser) {
                        window.fileBrowser.open('file', {
                            title: '@Html.Raw(AppConfig.GetLocalized("Mods:FileBrowserTitle", "选择 Zip 文件"))',
                            extensions: ['.zip'],
                            onFileSelected: function(filePath) {
                                installMod(filePath);
                            },
                            hideFileFilter: true
                        });
                    }
                });
            }
        });
        
        async function installMod(filePath) {
            const fileName = filePath.split(/[\\/]/).pop();
            if (confirm('确定要安装 Mod: ' + fileName + ' 吗？')) {
                try {
                    const response = await fetch('/api/mods/install', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ filePath: filePath })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        alert('Mod 安装成功！');
                        if (window.ModRenderer) {
                            window.ModRenderer.refresh();
                        }
                    } else {
                        alert('Mod 安装失败: ' + (data.message || '未知错误'));
                    }
                } catch (error) {
                    alert('安装 Mod 时出错: ' + error.message);
                }
            }
        }
    </script>
}
